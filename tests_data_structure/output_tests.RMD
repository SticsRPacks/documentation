---
title: "Model output test"
output:
  html_document:
    number_sections: true
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE,
                      cache.lazy = TRUE,
                      warn = -1)
source("output_tests.R")
```


# Introduction

In this document, we will implement two methods to store the model output. The first method will be a list of tibble, the second method is a single tibble.
First there will be a brief description of each method. Then a brief explication of what each method do and how they works with the results they give.
Then we will do some tests in order to decide which method is the best for the model output storage.

# Methods presentation

## First method's presentation

The first method is a list of tibble, let's print it to see how it is !
We'll print a list which contains 2 levels of DoE and 6 usms.

```{r print list}
# DoE, usm_number
li <- create_list(USM_list_1996,2,6,sim_data)
li
```

## Second method's presentation

The second method is a single tibble, let's print it to see how it is !
We'll print a single tibble which contains two levels of DoE and 6 usms.

```{r print tibble}
# DoE, usm_number
tb <- create_tibble(USM_list_1996,2,6,sim_data)
tb
```

# Use cases examples and results

Now we'll see what gives each functions and how to call them.

## Optimization function

We're beginning with the optimization function.
This function returns all the values for a variable with the dates.
It takes as parameters a DoE level, a usm name and a variable name.

```{r optimization function}

res <- tibble_get_dates_and_var_values(tb,1,"bo96iN+_2","HR_1")
res

li2 <- list_get_dates_and_var_values(li,1,"bo96iN+_2","HR_1")
li2

```

## Multi-simulation function

This function returns the usm names with the variable values.
It takes as parameters a DoE level, a variable name and a date.

```{r multisim function,warning=FALSE}

res <- tibble_get_usm_names_and_var_values(tb,1,"HR_4","1996-01-05")
res

li2 <- list_get_usm_names_and_var_values(li,1,"HR_4","1996/01/05-00/00/00")
li2

```

## Analysis function

This function returns the DoE levels and the variable values.
It takes as parameters an usm name, a variable name and a date.

```{r analysis function, warning=FALSE}

res <- tibble_get_DOE_and_var_values(tb,"bo96iN+_2","HR_3","1996-01-05")
res

li2 <- list_get_DOE_and_var_values(li,"bo96iN+_1","HR_3","1996/01/05-00/00/00")
li2

```

# Tests

In this section we'll made two types of tests.
First a generation test to determine for several DoE size which methods instanciation is the faster.
Then we will do the same for the extractions functions previously shown.

## Creation tests

### Tibble Creation Tests

```{r tests creation tibble}

tb_opti1 = create_tibble(USM_list_1996,5,10,sim_data)
tb_weights <- object.size(tb_opti1)
tb_opti2 = create_tibble2(USM_list_1996,5,10,sim_data)
tb_weights <- append(tb_weights,object.size(tb_opti2))
tb_multi1 = create_tibble(USM_list_1996,10,10,sim_data)
tb_weights <- append(tb_weights,object.size(tb_multi1))
tb_multi2 = create_tibble2(USM_list_1996,10,10,sim_data)
tb_weights <- append(tb_weights,object.size(tb_multi2))
tb_analysis1 = create_tibble(USM_list_1996,50,10,sim_data)
tb_weights <- append(tb_weights,object.size(tb_analysis1))
tb_analysis2 = create_tibble2(USM_list_1996,50,10,sim_data)
tb_weights <- append(tb_weights,object.size(tb_analysis2))

plot_weight <- data.frame(Instanciation_modes = c("tb_opti1","tb_opti2","tb_multi1","tb_multi2",
                                                  "tb_analysis1","tb_analysis2"),
                          weights = tb_weights)

graph <- ggplot(data = plot_weight,aes(x =Instanciation_modes, y=weights)) + geom_bar(stat = "identity")
print(graph)

benchmark <- microbenchmark(tb_opti1 = create_tibble(USM_list_1996,5,10,sim_data),
                            tb_opti2 = create_tibble2(USM_list_1996,5,10,sim_data),
                            tb_multi1 = create_tibble(USM_list_1996,10,10,sim_data),
                            tb_multi2 = create_tibble2(USM_list_1996,10,10,sim_data),
                            tb_analysis1 = create_tibble(USM_list_1996,50,10,sim_data),
                            tb_analysis2 = create_tibble2(USM_list_1996,50,10,sim_data),
                            times = 100)

benchmark

ggplot2::autoplot(benchmark)

```

### List Creation Tests

```{r tests creation list}

li_opti1 = create_list(USM_list_1996,5,10,sim_data)
li_weights <- object.size(li_opti1)
li_opti2 = create_list2(USM_list_1996,5,10,sim_data)
li_weights <- append(li_weights,object.size(li_opti2))
li_multi1 = create_list(USM_list_1996,10,10,sim_data)
li_weights <- append(li_weights,object.size(li_multi1))
li_multi2 = create_list2(USM_list_1996,10,10,sim_data)
li_weights <- append(li_weights,object.size(li_multi2))
li_analysis1 = create_list(USM_list_1996,50,10,sim_data)
li_weights <- append(li_weights,object.size(li_analysis1))
li_analysis2 = create_list2(USM_list_1996,50,10,sim_data)
li_weights <- append(li_weights,object.size(li_analysis2))

plot_weight <- data.frame(Instanciation_modes = c("li_opti1","li_opti2","li_multi1","li_multi2",
                                                  "li_analysis1","li_analysis2"),
                          weights = li_weights)

graph <- ggplot(data = plot_weight,aes(x =Instanciation_modes, y=weights)) + geom_bar(stat = "identity")
print(graph)

benchmark <- microbenchmark(li_opti1 = create_list(USM_list_1996,5,10,sim_data),
                            li_opti2 = create_list2(USM_list_1996,5,10,sim_data),
                            li_multi1 = create_list(USM_list_1996,10,10,sim_data),
                            li_multi2 = create_list2(USM_list_1996,10,10,sim_data),
                            li_analysis1 = create_list(USM_list_1996,50,10,sim_data),
                            li_analysis2 = create_list2(USM_list_1996,50,10,sim_data),
                            times = 100)
benchmark

ggplot2::autoplot(benchmark)


```

### Best Creation Tests

```{r tests creation best}

tb_opti = create_tibble2(USM_list_1996,5,10,sim_data)
weights <- object.size(tb_opti)
li_opti = create_list2(USM_list_1996,5,10,sim_data)
weights <- append(weights,object.size(li_opti))
tb_multi = create_tibble2(USM_list_1996,10,10,sim_data)
weights <- append(weights,object.size(tb_multi))
li_multi = create_list2(USM_list_1996,10,10,sim_data)
weights <- append(weights,object.size(li_multi))
tb_analysis = create_tibble2(USM_list_1996,50,10,sim_data)
weights <- append(weights,object.size(tb_analysis))
li_analysis = create_list2(USM_list_1996,50,10,sim_data)
weights <- append(weights,object.size(li_analysis))

plot_weight <- data.frame(Instanciation_modes = c("tb_opti","li_opti","tb_multi","li_multi","tb_analysis",
                                                  "li_analysis"),
                          weights = weights)

graph <- ggplot(data = plot_weight,aes(x =Instanciation_modes, y=weights)) + geom_bar(stat = "identity")
print(graph)

benchmark <- microbenchmark(tb_opti = create_tibble2(USM_list_1996,5,10,sim_data),
                            li_opti = create_list2(USM_list_1996,5,10,sim_data),
                            tb_multi = create_tibble2(USM_list_1996,10,10,sim_data),
                            li_multi = create_list2(USM_list_1996,10,10,sim_data),
                            tb_analysis = create_tibble2(USM_list_1996,50,10,sim_data),
                            li_analysis = create_list2(USM_list_1996,50,10,sim_data),
                            times = 100)
benchmark

ggplot2::autoplot(benchmark)


```

## Extraction tests

First, let's create the instances we will use for the following tests.

```{r instanciation for extraction}
# DOE, usm_number
opti_li <- create_list2(USM_list_1996,625,200,sim_data)
```
```{r tests multi li}
multi_li <- create_list2(USM_list_1996,1,1000000,sim_data)
```
```{r tests analysis li}
analysis_li <- create_list2(USM_list_1996,50000,100,sim_data)
```
```{r tests opti tb}
opti_tb <- create_tibble2(USM_list_1996,50,10,sim_data)
```
```{r testts multi tb}
multi_tb <- create_tibble2(USM_list_1996,1,500,sim_data)
```
```{r tests analysis tb}
analysis_tb <- create_tibble2(USM_list_1996,50,10,sim_data)
```

### Optimization's extraction test

```{r opti tests extraction, message=FALSE,warning=FALSE}

benchmark_opti <- microbenchmark(tb = tibble_get_dates_and_var_values(opti_tb,1,"bo96iN+_2","HR_1"),
                                 li = list_get_dates_and_var_values(opti_li,1,"bo96iN+_2","HR_1"),
                                 times = 100)

benchmark_opti

ggplot2::autoplot(benchmark_opti)

```

### Multi-simulation's extraction test

```{r multi tests extraction, message=FALSE, warning=FALSE }

benchmark_multi <- microbenchmark(tb = tibble_get_usm_names_and_var_values(multi_tb,1,"HR_4","1996-01-05"),
                                  li = list_get_usm_names_and_var_values(multi_li,1,"HR_4","1996/01/05-00/00/00"),
                                  times = 100)

benchmark_multi

ggplot2::autoplot(benchmark_multi)

```

### Analysis' extraction test

```{r analysis tests extraction, message=FALSE, warning=FALSE}

benchmark_analysis <- microbenchmark(tb = 
                                       tibble_get_DOE_and_var_values(analysis_tb,"bo96iN+_2","HR_3","1996-01-05"),
                                     li = list_get_DOE_and_var_values(analysis_li,"bo96iN+_2","HR_3",
                                                                      "1996/01/05-00/00/00"),
                                     times = 100)

benchmark_analysis

ggplot2::autoplot(benchmark_analysis)

```