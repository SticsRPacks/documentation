---
title: "Model output test"
output:
  pdf_document: default
  html_document:
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE,
                      cache.lazy = TRUE,
                      warn = -1)
source("output_tests.R")
```


# Introduction

In this document, we will implement two methods to store the model output. The first method will be a list of tibble, the second method is a single tibble.
First there will be a brief description of each method. Then a brief explication of what each method do and how they works with the results they give.
Then we will do some tests in order to decide which method is the best for the model output storage.

# Methods presentation

## First method's presentation

The first method is a list of tibble, let's print it to see how it is !
We'll print a list which contains 2 levels of DoE and 6 usms.

```{r print list}
# DoE, usm_number
li <- create_list(USM_list_1996,2,6,sim_data)
li
```

## Second method's presentation

The second method is a single tibble, let's print it to see how it is !
We'll print a single tibble which contains two levels of DoE and 6 usms.

```{r print tibble}
# DoE, usm_number
tb <- create_tibble(USM_list_1996,2,6,sim_data)
tb
```

# Use cases examples and results

Now we'll see what gives each functions and how to call them.

## Optimization function

We're beginning with the optimization function.
This function returns all the values for a variable with the dates.
It takes as parameters a DoE level, a usm name and a variable name.

```{r optimization function}

res <- tibble_get_dates_and_var_values(tb,1,"bo96iN+_2","HR_1")
res

li2 <- list_get_dates_and_var_values(li,1,"bo96iN+_2","HR_1")
li2

```

## Multi-simulation function

This function returns the usm names with the variable values.
It takes as parameters a DoE level, a variable name and a date.

```{r multisim function,warning=FALSE}

res <- tibble_get_usm_names_and_var_values(tb,1,"HR_4","1996-01-05")
res

li2 <- list_get_usm_names_and_var_values(li,1,"HR_4","1996/01/05-00/00/00")
li2

```

## Analysis function

This function returns the DoE levels and the variable values.
It takes as parameters an usm name, a variable name and a date.

```{r analysis function, warning=FALSE}

res <- tibble_get_DOE_and_var_values(tb,"bo96iN+_2","HR_3","1996-01-05")
res

li2 <- list_get_DOE_and_var_values(li,"bo96iN+_1","HR_3","1996/01/05-00/00/00")
li2

```

# Tests

In this section we'll made two types of tests.
First a generation test to determine for several DoE size which methods instanciation is the faster.
Then we will do the same for the extractions functions previously shown.

## Creation tests

### Tibble Creation Tests

```{r tests creation tibble, eval=FALSE, echo = TRUE}

benchmark <- microbenchmark(create_tibble(USM_list_1996,10,500,sim_data),
                            create_tibble2(USM_list_1996,10,500,sim_data),
                            create_tibble3(USM_list_1996,10,500,sim_data),
                            times = 10)

benchmark

ggplot2::autoplot(benchmark)


 benchmark
Unit: milliseconds
                                             expr          min           lq         mean       median           uq          max neval
  create_tibble(USM_list_1996, 10, 500, sim_data) 1205804.5078 1226858.2402 1697771.5727 1714676.4753 2106422.4782 2266344.2604    10
 create_tibble2(USM_list_1996, 10, 500, sim_data)     116.8153     138.8559     275.4744     172.8570     345.1159     604.2929    10
 create_tibble3(USM_list_1996, 10, 500, sim_data)     749.7182     775.1101    1084.8669     895.9864    1170.2665    1898.2863    10
```
![benchmark creation tibble](C:/Users/Thomas/Documents/GitHub/documentation/tests_data_structure/benchmark_tibble_creation.png)


### List Creation Tests

```{r tests creation list}

benchmark <- microbenchmark(create_list(USM_list_1996,10,50,sim_data),
                            create_list2(USM_list_1996,10,50,sim_data),
                            times = 10)
benchmark

ggplot2::autoplot(benchmark)


```

### Best Creation Tests

```{r tests creation best}

tb1 = create_tibble2(USM_list_1996,10,500,sim_data)
weights <- object.size(tb1)
li1 = create_list2(USM_list_1996,10,500,sim_data)
weights <- append(weights,object.size(li1))
tb2 = create_tibble2(USM_list_1996,100,500,sim_data)
weights <- append(weights,object.size(tb2))
li2 = create_list2(USM_list_1996,100,500,sim_data)
weights <- append(weights,object.size(li2))

plot_weight <- data.frame(Instanciation_modes = c("tb1","li1","tb2","li2"), weights = weights)

graph <- ggplot(data = plot_weight,aes(x =Instanciation_modes, y=weights)) + geom_bar(stat = "identity")
print(graph)

benchmark <- microbenchmark(tb1 = create_tibble2(USM_list_1996,10,500,sim_data),
                            li1 = create_list2(USM_list_1996,10,500,sim_data),
                            tb2 = create_tibble2(USM_list_1996,100,500,sim_data),
                            li2 = create_list2(USM_list_1996,100,500,sim_data),
                            times = 10)
benchmark

ggplot2::autoplot(benchmark)


```

## Extraction tests

### Optimization's extraction test

We have done tests for optimization with 2 differents setups. The first one was : 10 usms, 289 dates and a doe size from 30K to 50k.
Here are the results for the first setup with the instructions below.
```{r opti tests extraction, eval=FALSE,echo=TRUE}

memory.limit(size = 8000000000000)
analysis_tb <- create_tibble2(USM_list_1996,50000,10,sim_data)
analysis_li <- create_list2(USM_list_1996,50000,10,sim_data)

benchmark_opti <- microbenchmark(list_get_dates_and_var_values(analysis_li,20000,"lu96iN6_2","HR_2"),
                            tibble_get_dates_and_var_values(analysis_tb,20000,"lu96iN6_2","HR_2"),
                            times = 10)
benchmark_opti

ggplot2::autoplot(benchmark_opti)


benchmark_opti
Unit: microseconds
                                                                           expr       min        lq       mean     median        uq     max
    list_get_dates_and_var_values(analysis_li, 20000, "lu96iN6_2",      "HR_2")      19.2      50.9     396.64      71.85      86.3    3241
  tibble_get_dates_and_var_values(analysis_tb, 20000, "lu96iN6_2",      "HR_2") 1095275.3 1174294.2 2088399.70 2007743.70 2403482.8 4481950
 tibble_get_dates_and_var_values5(analysis_tb, 20000, "lu96iN6_2",      "HR_2")  349193.2  390438.8  804004.04  540990.85  853319.8 2777321
 neval
    10
    10
    10
```
![benchmark optimization doe = 30K](C:/Users/Thomas/Documents/GitHub/documentation/tests_data_structure/benchmark_optimisation3.png)
```{r results, eval=FALSE,echo=TRUE}
benchmark_opti
Unit: microseconds

  list_get_dates_and_var_values(analysis_li, 20000, "lu96iN6_2",      "HR_2")      10.5      29.2     637.03      65.75    1146.3    2904.3
  tibble_get_dates_and_var_values(analysis_tb, 20000, "lu96iN6_2",      "HR_2") 1518334.7 2335415.4 2879144.16 2974978.65 3437696.4 4399059.8
 tibble_get_dates_and_var_values5(analysis_tb, 20000, "lu96iN6_2",      "HR_2")  448393.5  466251.2  850613.47  574729.15  954900.9 2503163.6
 neval
    10
    10
    10
```
![benchmark optimization doe = 40K](C:/Users/Thomas/Documents/GitHub/documentation/tests_data_structure/benchmark_optimisation2.png)
```{r results2,eval=FALSE,echo=TRUE}
benchmark_opti
Unit: microseconds
                                                                           expr       min        lq       mean     median        uq       max
    list_get_dates_and_var_values(analysis_li, 20000, "lu96iN6_2",      "HR_2")      37.8      55.2    1447.15      80.55     624.2   11017.8
  tibble_get_dates_and_var_values(analysis_tb, 20000, "lu96iN6_2",      "HR_2") 1764334.4 2020204.9 3430751.11 3340715.80 4517511.5 6348134.8
 tibble_get_dates_and_var_values5(analysis_tb, 20000, "lu96iN6_2",      "HR_2")  607974.2  619416.0  860294.90  666121.00 1016646.7 1668692.9
 neval
    10
    10
    10
```
![benchmark optimization doe = 50K](C:/Users/Thomas/Documents/GitHub/documentation/tests_data_structure/benchmark_optimisation.png)

Now let's move on to the second setup. This time the setup was Usms : 100, Dates : 20 and the DoE was 1 and 50K

```{r results3,eval=FALSE,echo=TRUE}

benchmark_opti
Unit: microseconds
                                                                       expr    min     lq    mean  median     uq    max neval
         list_get_dates_and_var_values(analysis_li, 1, "lu96iN6_2", "HR_2")   11.0   11.4  189.42   14.50   19.7 1758.3    10
  tibble_get_dates_and_var_values(analysis_tb, 1, "lu96iN6_2",      "HR_2") 1920.8 1949.8 2468.88 1988.80 2382.3 5841.2    10
 tibble_get_dates_and_var_values5(analysis_tb, 1, "lu96iN6_2",      "HR_2")  147.8  173.7  538.74  205.05  345.3 3215.5    10

```
![benchmark optimization alternative doe = 1](C:/Users/Thomas/Documents/GitHub/documentation/tests_data_structure/benchmark_optimisation_alternative2.png)

```{r results4,eval=FALSE,echo=TRUE}

benchmark_opti
Unit: microseconds
                                                                           expr       min        lq       mean     median        uq       max
    list_get_dates_and_var_values(analysis_li, 20000, "lu96iN6_2",      "HR_2")      11.3      13.6     664.99      43.05      74.6    6023.5
  tibble_get_dates_and_var_values(analysis_tb, 20000, "lu96iN6_2",      "HR_2") 1446252.8 1559956.6 2089331.53 1780299.30 2828106.5 3186232.5
 tibble_get_dates_and_var_values5(analysis_tb, 20000, "lu96iN6_2",      "HR_2")  417350.2  458109.0  689871.22  582912.70  792087.4 1520566.0
 neval
    10
    10
    10
```
![benchmark optimization alternative doe = 50K](C:/Users/Thomas/Documents/GitHub/documentation/tests_data_structure/benchmark_optimisation_alternative2.png)
    
### Multi-simulation's extraction test

For these tests the setup is the same as for the first setup for the previous tests.

```{r multi tests extraction, eval=FALSE,echo=TRUE }

benchmark_multi <- microbenchmark(list_get_usm_names_and_var_values(multi_li,1,"resmes","1996/01/05-00/00/00"),
                                  list_get_usm_names_and_var_values2(multi_li,1,"resmes","1996/01/05-00/00/00"),
                                  tibble_get_usm_names_and_var_values(multi_tb,1,"resmes","1996-01-05"),
                                  times = 10)

benchmark_multi

ggplot2::autoplot(benchmark_multi)

benchmark_multi
Unit: seconds
                                                                            expr         min          lq        mean      median          uq         max  neval
 list_get_usm_names_and_var_values(multi_li, 1, "resmes", "1996/01/05-00/00/00")   472.58253   506.75464   508.38593   513.53400   516.11212   531.27242     10
list_get_usm_names_and_var_values2(multi_li, 1, "resmes", "1996/01/05-00/00/00")  1208.05894  1237.58274  1307.44368  1290.06657  1390.88367  1433.95392     10
        tibble_get_usm_names_and_var_values(multi_tb, 1, "resmes", "1996-01-05")    20.79821    25.17123    28.48254    30.43341    31.94993    32.89422     10

```
![benchmark multisimulation doe = 50K](C:/Users/Thomas/Documents/GitHub/documentation/tests_data_structure/benchmark_multi.png)

Due to its huge time to execution, I only did this test for the multisimulation.

### Analysis' extraction test

For the last part, there were 2 setups again and the first is the same as previously.
```{r analysis tests extraction, eval=FALSE,echo=TRUE}

benchmark_analysis <- microbenchmark(list_get_DOE_and_var_values(analysis_li,"lu96iN6_2","HR_3","1996/01/05-00/00/00"),
                                     list_get_DOE_and_var_values2(analysis_li,"lu96iN6_2","HR_3","1996/01/05-00/00/00"),
                                     tibble_get_DOE_and_var_values(analysis_tb,"lu96iN6_2","HR_3","1996-01-05"),
                                     times = 10)

benchmark_analysis

ggplot2::autoplot(benchmark_analysis)


benchmark_analysis
Unit: seconds
                                                                                       expr       min        lq      mean    median        uq
  list_get_DOE_and_var_values(analysis_li, "lu96iN6_2", "HR_3",      "1996/01/05-00/00/00") 28.914541 29.040595 29.456588 29.515648 29.755601
 list_get_DOE_and_var_values2(analysis_li, "lu96iN6_2", "HR_3",      "1996/01/05-00/00/00") 83.904040 84.128775 86.844912 84.964032 90.716094
         tibble_get_DOE_and_var_values(analysis_tb, "lu96iN6_2", "HR_3",      "1996-01-05")  1.043275  1.131608  1.656888  1.145708  1.276536
       max neval
 30.079276    10
 91.340364    10
  5.108274    10

```
![benchmark analysis doe = 30K](C:/Users/Thomas/Documents/GitHub/documentation/tests_data_structure/benchmark_analysis3.png)

```{r results5,eval=FALSE,echo=TRUE}

benchmark_analysis
Unit: seconds
                                                                                       expr        min         lq       mean     median
  list_get_DOE_and_var_values(analysis_li, "lu96iN6_2", "HR_3",      "1996/01/05-00/00/00")  37.444758  37.538009  37.672624  37.601526
 list_get_DOE_and_var_values2(analysis_li, "lu96iN6_2", "HR_3",      "1996/01/05-00/00/00") 110.868956 111.069417 111.583752 111.127231
         tibble_get_DOE_and_var_values(analysis_tb, "lu96iN6_2", "HR_3",      "1996-01-05")   1.332319   1.347602   1.737762   1.430313
         uq       max neval
  37.783689  38.06203    10
 112.282223 113.48493    10
   1.475008   4.53400    10

```
![benchmark analysis doe = 40K](C:/Users/Thomas/Documents/GitHub/documentation/tests_data_structure/benchmark_analysis2.png)

```{r results6,eval=FALSE,echo=TRUE}

benchmark_analysis
Units: seconds
                                                                                       expr        min        lq      mean     median          uq        max neval
  list_get_DOE_and_var_values(analysis_li, "lu96iN6_2", "HR_3",      "1996/01/05-00/00/00")  46.614714  46.73028  46.84814  46.784283   46.860336   47.33477    10
 list_get_DOE_and_var_values2(analysis_li, "lu96iN6_2", "HR_3",      "1996/01/05-00/00/00") 138.130626 138.18503 139.14051 138.531919  139.583565  143.45237    10
         tibble_get_DOE_and_var_values(analysis_tb, "lu96iN6_2", "HR_3",      "1996-01-05")   5.296121   6.64279   8.16800   7.407002    8.576818   14.07083    10

```

![benchmark analysis doe = 50K](C:/Users/Thomas/Documents/GitHub/documentation/tests_data_structure/benchmark_analysis.png)

And now for the second setup, we had DoE : 50K, Usms : 10 and Dates : 5

```{r results7,eval=FALSE,echo=TRUE}

benchmark_analysis
Unit: milliseconds
                                                                                       expr        min         lq        mean     median
  list_get_DOE_and_var_values(analysis_li, "lu96iN6_2", "HR_3",      "1996/01/05-00/00/00") 27960.7493 28229.1338 28445.23886 28305.2090
 list_get_DOE_and_var_values2(analysis_li, "lu96iN6_2", "HR_3",      "1996/01/05-00/00/00") 85314.3847 85554.0336 86131.13795 86150.9427
         tibble_get_DOE_and_var_values(analysis_tb, "lu96iN6_2", "HR_3",      "1996-01-05")    38.0997    38.8624    43.07571    39.3686
        uq        max neval
 28566.931 29592.0164    10
 86540.120 87422.5074    10
    44.827    59.5882    10

```
![benchmark analysis alternative doe = 50K, Usms = 10, Dates = 5](C:/Users/Thomas/Documents/GitHub/documentation/tests_data_structure/benchmark_analysis_alternative.png)