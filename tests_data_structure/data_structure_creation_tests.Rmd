---
title: "data_structure"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE,
                      cache.lazy = TRUE,
                      warn = -1)
source("data_structure_functions.R")
library(tibble)
library(data.table)
library(tidyverse)
library(microbenchmark)
library(dplyr)
library(ggplot2)
library(memuse)
library(lobstr)

# list which store the differents instances' size
num_elem <- c(10000,100000,1000000)
options(warn=-1)
```

# I. Introduction 

In order to boost the program, we want to use a datatype structure that is light and robust, in 
order to contains the model's inputs (USMS).
What will follow in this document are the tests done in the purpose of determining the best datatype
structure suited for that.
The tests will concern the generation speed, the memory weight and the manipulation ease.

## I.A The Dataypes structures

Initially, they were 6 candidates :

- The List type
- The Reference Class type
- The DataFrame type
- The DataTable type
- The Tibble type
- The Matrix type

However, the Matrix type was the first one to be put away because it can only contains informations
with homogenous types (e.g only numeric or character but not numeric and character together). Or, an
USM is composed of :

- a name (character)
- a beginning date (numeric)
- an ending date (numeric)
- an initialisation file name (character)
- the ground name (character)
- a station file name (character)
- a first climate file name (character)
- a second climate file name (character)
- the year of culture (numeric)
- the number of plants (numeric)
- the simulation_code (numeric)
- informations about the first plant (3 informations(fplt,ftec,flai)) (character)
- informations about the second plant (same)
- the observation file name (character)

So here are examples of usm in the remaining datatypes.

### I.A.1 List

```{r example usm list}

example_usm_list <- usm_list("usm_1","sol_canne")
example_usm_list

```

### I.A.2 Class

```{r example usm class}
example_usm_class <- usm_class("usm_1","sol_canne")
example_usm_class

```

### I.A.3 DataFrame

```{r example usm dataframe}

example_usm_dataframe <- usm_dataframe("usm_1","sol_canne")
example_usm_dataframe

```

### I.A.4 DataTable

```{r example usm datatable}

example_usm_datatable <- data.table(usm_dataframe("usm_1","sol_canne"))
example_usm_datatable

```

### I.A.5 Tibble

```{r example usm tibble}

example_usm_tibble <- tibble::as_tibble(usm_dataframe("usm_1","sol_canne"))
example_usm_tibble

```

# II. Tests

The firsts tests to be made were instanciation tests. We tested the instanciation time and weight
for each datatype structure with different instanciation method and for differents sizes (10 000,
100 000, 1 000 000)

## II.A Instanciation Tests

### II.A.1 Non Pre-Allocated Vs Pre-Allocated

These tests were made for list and class types because only these two types can be instanciated
with a non pre-allocated method, which is not possible for the other types.

```{r npa vs pa}

 # list which contains the structures' types
Structures_types <- c("list","class")
 # list which contains the differents instanciations methods
Instanciation_methods <- c("NPA","Vector","Lapply")

# main loop
for (i in num_elem) {
  
  i <- i/10
  
  cat("\nNumber of elements : ",i,"\n")
  
  # loop that will take vector_method and lapply_method together for the same structure because
  # list_vector and list_lapply have the same size
  for (j in 1:length(Structures_types)) {
    
      cat(Structures_types[j],"\n")
    
      # instance_weight will be used to store the weight of the instances in the i-th loop
      test <- eval(parse(text=paste("NPA_list_of_",Structures_types[j],"(",i,")",sep="")))
      instance_weight <- object.size(test)
      
      test <- eval(parse(text=paste("list_of_usm_",Structures_types[j],"_by_vector(",i,")",sep="")))
      instance_weight <- append(instance_weight,object.size(test))
    
      test <- eval(parse(text=paste("list_of_usm_",Structures_types[j],"_by_lapply(",i,")",sep="")))
      instance_weight <- append(instance_weight,object.size(test))
    
      plot_weight <- data.frame(Instanciation_modes = Instanciation_methods,
                                weights = instance_weight)
    
      graph <- ggplot(data = plot_weight,aes(x =Instanciation_modes, y=weights)) +
        geom_bar(stat = "identity")
      print(graph + ggtitle(sprintf("%d %s %s",i," elements ",Structures_types[j])))
    
      benchmark <- microbenchmark(NPA = eval(parse(text=paste("NPA_list_of_",Structures_types[j],
                                                              "(",i,")",sep=""))),
                                  Vector = eval(parse(text=paste("list_of_usm_",Structures_types[j],
                                                                 "_by_vector(",i,")",sep=""))),
                                  Lapply= eval(parse(text=paste("list_of_usm_",Structures_types[j],
                                                                "_by_lapply(",i,")",sep=""))),
                                  times = 3)
      
      plot_time <- data.frame(Instanciation_modes = Instanciation_methods,
                              mean_times = log10(summary(benchmark)$mean))
    
      graph <- ggplot(data = plot_time,aes(x = Instanciation_modes, y=mean_times)) +
        geom_bar(stat = "identity")
      print(graph + ggtitle(sprintf("%d %s %s",i," elements ",Structures_types[j])))
    
      print(ggplot2::autoplot(benchmark) + ggtitle(sprintf("%s %d %s %s","Duration tests for a ",
                                                     i," elements ",Structures_types[j])))
    }
}
```

Even, if the NPA instanciation is 'lighter' than the others, its huge instanciation time makes that we will not use it. Indeed, during the tests, we must divide by hundred the number of usm the NPA contains because it will last more tha 3 days before it creates a 1M usms structure. 

### II.A.2 DataFrame, DataTable and Tibble

Now, let's move on to the tests involving the DataFrame,DataTable and Tibble instanciation methods.
Indeed, they are severals ways to instanciate each of these types. 
DataFrame : By affecting list in a dataframe's row or by row binding a list of dataframe.
DataTable : Doing the same as before but for a DataTable or by casting the DataFrame output into a 
DataTable.
Tibble : Same ways as for DataTable

``` {r df,dt,tb}

# list which contains the structures' types
Structures_types <- c("dataframe","datatable","tibble")
# list which contains the differents instanciations methods
Instanciation_methods <- c("Directly","Vector","Lapply")
Instanciation_methods_bis <- c("Directly","By_Df_by_Vector","By_Df_by_Lapply","By_df_directly")

# main loop
for (i in num_elem) {
  
  cat("\nNumber of elements : ",i,"\n")

  # loop that will take vector_method and lapply_method together for the same structure because
  # list_vector and list_lapply have the same size
  for (j in 1:length(Structures_types)) {
    
      cat(Structures_types[j],"\n")
      
      test <- eval(parse(text=paste("usm_",Structures_types[j],"_by_",Structures_types[j],"(",i,")",
                                    sep="")))
      instance_weight <- object.size(test)
      
      if (j == 1) {  # Dataframe  
        
        test <- eval(parse(text=paste("usm_",Structures_types[j],"_by_vector(",i,")",
                                      sep="")))
        instance_weight <- append(instance_weight,object.size(test))
      
        test <- eval(parse(text=paste("usm_",Structures_types[j],"_by_lapply(",i,")",
                                      sep="")))
        instance_weight <- append(instance_weight,object.size(test))
        
        plot_weight <- data.frame(Instanciation_modes = Instanciation_methods,
                                weights = instance_weight)
    
        graph <- ggplot(data = plot_weight,aes(x =Instanciation_modes, y=weights)) +
          geom_bar(stat = "identity")
        print(graph + ggtitle(sprintf("%d %s %s",i," elements ",Structures_types[j])))
      
        benchmark <- microbenchmark(Directly=eval(parse(text=paste("usm_",Structures_types[j],
                                                                   "_by_",Structures_types[j],
                                                                   "(",i,")",sep=""))),
                                    Vector=eval(parse(text=paste("usm_",Structures_types[j],
                                                                 "_by_vector(",i,")",sep=""))),
                                    Lapply=eval(parse(text=paste("usm_",Structures_types[j],
                                                                 "_by_lapply(",i,")",sep=""))),
                                    times = 3)
        
        plot_time <- data.frame(Instanciation_modes = Instanciation_methods,
                                mean_times = log10(summary(benchmark)$mean))
      
        graph <- ggplot(data = plot_time,aes(x = Instanciation_modes, y=mean_times)) +
          geom_bar(stat = "identity")
        print(graph + ggtitle(sprintf("%d %s %s",i," elements ",Structures_types[j])))
      
        print(ggplot2::autoplot(benchmark) + ggtitle(sprintf("%s %d %s %s","Duration tests for a ",
                                                       i," elements ",Structures_types[j])))
          
      }
      else { # DataTable & tibble
        
        test <- eval(parse(text=paste("usm_",Structures_types[j],
                                      "_by_usm_dataframe_by_vector(",i,")",sep="")))
        instance_weight <- append(instance_weight,object.size(test))
        
        test <- eval(parse(text=paste("usm_",Structures_types[j],
                                      "_by_usm_dataframe_by_lapply(",i,")",sep="")))
        instance_weight <- append(instance_weight,object.size(test))
        
        test <- eval(parse(text=paste("usm_",Structures_types[j],
                                      "_by_usm_dataframe_by_dataframe(",i,")",sep="")))
        instance_weight <- append(instance_weight,object.size(test))
        
        plot_weight <- data.frame(Instanciation_modes = Instanciation_methods_bis,
                                weights = instance_weight)
    
        graph <- ggplot(data = plot_weight,aes(x =Instanciation_modes, y=weights)) +
          geom_bar(stat = "identity")
        print(graph + ggtitle(sprintf("%d %s %s",i," elements ",Structures_types[j])))
      
        benchmark <- microbenchmark(Directly=eval(parse(text=paste("usm_",Structures_types[j],
                                                                   "_by_",Structures_types[j],
                                                                   "(",i,")",sep=""))),
                                    Vector=eval(parse(text=paste("usm_",Structures_types[j],
                                      "_by_usm_dataframe_by_vector(",i,")",sep=""))),
                                    Lapply=eval(parse(text=paste("usm_",Structures_types[j],
                                      "_by_usm_dataframe_by_lapply(",i,")",sep=""))),
                                    Df=eval(parse(text=paste("usm_",Structures_types[j],
                                      "_by_usm_dataframe_by_dataframe(",i,")",sep=""))),
                                    times = 3)
        
        plot_time <- data.frame(Instanciation_modes = Instanciation_methods_bis,
                                mean_times = log10(summary(benchmark)$mean))
      
        graph <- ggplot(data = plot_time,aes(x = Instanciation_modes, y=mean_times)) +
          geom_bar(stat = "identity")
        print(graph + ggtitle(sprintf("%d %s %s",i," elements ",Structures_types[j])))
      
        print(ggplot2::autoplot(benchmark) + ggtitle(sprintf("%s %d %s %s","Duration tests for a ",
                                                       i," elements ",Structures_types[j])))
      }
    }
}
```

## II.B Most suitable datatype structure

```{r best datatype structure}

# list which contains the structures' types
Structures_types <- c("list","class","dataframe","datatable","tibble")
# list which contains the differents instanciations methods
Instanciation_methods <- c("Directly","Vector","Lapply")
Instanciation_methods_bis <- c("Directly","By_Df_by_Vector","By_Df_by_Lapply","By_df_directly")
Instanciation_methods_ter <- c("Vector","Lapply")

# used for global recap plot
all_weight <- list() # used to store the minimum weights for all the instances
all_time <- list() # used to store the minimum generation time for all the instances

# main loop
for (i in num_elem) {
  
  cat("\nNumber of elements : ",i,"\n")
  
  # loop_weight will be used to store the min weight among the instances' weights in the j-th loop
  loop_weight <- list()
  # loop_time is the same as loop_weight but it will store the min generation time
  loop_time <- list()

  # loop that will take vector_method and lapply_method together for the same structure because
  # list_vector and list_lapply have the same size
  for (j in 1:length(Structures_types)) {
    
      cat(Structures_types[j],"\n")
      
      if (j < 3) {
       
        test <- eval(parse(text=paste("list_of_usm_",Structures_types[j],"_by_vector(",i,")",
                                      sep="")))
        instance_weight <- object.size(test)
      
        test <- eval(parse(text=paste("list_of_usm_",Structures_types[j],"_by_lapply(",i,")",
                                      sep="")))
        instance_weight <- append(instance_weight,object.size(test))
      
        plot_weight <- data.frame(Instanciation_modes = Instanciation_methods_ter,
                                  weights = instance_weight)
      
        graph <- ggplot(data = plot_weight,aes(x =Instanciation_modes, y=weights)) +
          geom_bar(stat = "identity")
        print(graph + ggtitle(sprintf("%d %s %s",i," elements ",Structures_types[j])))
      
        benchmark <- microbenchmark(Vector = eval(parse(text=paste("list_of_usm_",
                                                                   Structures_types[j],
                                                                   "_by_vector(",i,")",sep=""))),
                                    Lapply= eval(parse(text=paste("list_of_usm_",
                                                                  Structures_types[j],
                                                                  "_by_lapply(",i,")",sep=""))),
                                    times = 3)
        
        plot_time <- data.frame(Instanciation_modes = Instanciation_methods_ter,
                                mean_times = log10(summary(benchmark)$mean))
      
        graph <- ggplot(data = plot_time,aes(x = Instanciation_modes, y=mean_times)) +
          geom_bar(stat = "identity")
        print(graph + ggtitle(sprintf("%d %s %s",i," elements ",Structures_types[j])))
      
        print(ggplot2::autoplot(benchmark) + ggtitle(sprintf("%s %d %s %s","Duration tests for a ",
                                                       i," elements ",Structures_types[j])))
        
        if (length(loop_weight) == 0) {
          loop_weight <- min(instance_weight)
          loop_time <- min(summary(benchmark)$mean)
        }
        else {
          loop_weight <- append(loop_weight,min(instance_weight))
          loop_time <- append(loop_time,min(summary(benchmark)$mean))
        }
        
        if (length(all_weight) == 0) {
          all_weight <- min(instance_weight)
          all_time <- min(summary(benchmark)$mean)
        }
        else {
          all_weight <- append(all_weight,min(instance_weight))
          all_time <- append(all_time,min(summary(benchmark)$mean))
        }
        
      }
      else {
        
        if (j == 3) {  # Dataframe  
          
          test <- eval(parse(text=paste("usm_",Structures_types[j],"_by_vector(",i,")",
                                        sep="")))
          instance_weight <- object.size(test)
        
          test <- eval(parse(text=paste("usm_",Structures_types[j],"_by_lapply(",i,")",
                                        sep="")))
          instance_weight <- append(instance_weight,object.size(test))
          
          plot_weight <- data.frame(Instanciation_modes = Instanciation_methods_ter,
                                  weights = instance_weight)
      
          graph <- ggplot(data = plot_weight,aes(x =Instanciation_modes, y=weights)) +
            geom_bar(stat = "identity")
          print(graph + ggtitle(sprintf("%d %s %s",i," elements ",Structures_types[j])))
        
          benchmark <- microbenchmark(Vector=eval(parse(text=paste("usm_",Structures_types[j],
                                                                   "_by_vector(",i,")",sep=""))),
                                      Lapply=eval(parse(text=paste("usm_",Structures_types[j],
                                                                   "_by_lapply(",i,")",sep=""))),
                                      times = 3)
          
          plot_time <- data.frame(Instanciation_modes = Instanciation_methods_ter,
                                  mean_times = log10(summary(benchmark)$mean))
        
          graph <- ggplot(data = plot_time,aes(x = Instanciation_modes, y=mean_times)) +
            geom_bar(stat = "identity")
          print(graph + ggtitle(sprintf("%d %s %s",i," elements ",Structures_types[j])))
        
          print(ggplot2::autoplot(benchmark) + ggtitle(sprintf("%s %d %s %s","Duration tests for a",
                                                         i," elements ",Structures_types[j])))
          
          if (length(loop_weight) == 0) {
            loop_weight <- min(instance_weight)
            loop_time <- min(summary(benchmark)$mean)
          }
          else {
            loop_weight <- append(loop_weight,min(instance_weight))
            loop_time <- append(loop_time,min(summary(benchmark)$mean))
          }
          
          if (length(all_weight) == 0) {
            all_weight <- min(instance_weight)
            all_time <- min(summary(benchmark)$mean)
          }
          else {
            all_weight <- append(all_weight,min(instance_weight))
            all_time <- append(all_time,min(summary(benchmark)$mean))
          }
            
        }
        else { # DataTable & tibble
          
          test <- eval(parse(text=paste("usm_",Structures_types[j],
                                        "_by_usm_dataframe_by_vector(",i,")",sep="")))
          instance_weight <- object.size(test)
          
          test <- eval(parse(text=paste("usm_",Structures_types[j],
                                        "_by_usm_dataframe_by_lapply(",i,")",sep="")))
          instance_weight <- append(instance_weight,object.size(test))
          
          plot_weight <- data.frame(Instanciation_modes = Instanciation_methods_ter,
                                  weights = instance_weight)
      
          graph <- ggplot(data = plot_weight,aes(x =Instanciation_modes, y=weights)) +
            geom_bar(stat = "identity")
          print(graph + ggtitle(sprintf("%d %s %s",i," elements ",Structures_types[j])))
        
          benchmark <- microbenchmark(Vector=eval(parse(text=paste("usm_",Structures_types[j],
                                        "_by_usm_dataframe_by_vector(",i,")",sep=""))),
                                      Lapply=eval(parse(text=paste("usm_",Structures_types[j],
                                        "_by_usm_dataframe_by_lapply(",i,")",sep=""))),
                                      times = 3)
          
          plot_time <- data.frame(Instanciation_modes = Instanciation_methods_ter,
                                  mean_times = log10(summary(benchmark)$mean))
        
          graph <- ggplot(data = plot_time,aes(x = Instanciation_modes, y=mean_times)) +
            geom_bar(stat = "identity")
          print(graph + ggtitle(sprintf("%d %s %s",i," elements ",Structures_types[j])))
        
          print(ggplot2::autoplot(benchmark) + ggtitle(sprintf("%s %d %s %s","Duration tests for a ",
                                                         i," elements ",Structures_types[j])))
          
          if (length(loop_weight) == 0) {
            loop_weight <- min(instance_weight)
            loop_time <- min(summary(benchmark)$mean)
          }
          else {
            loop_weight <- append(loop_weight,min(instance_weight))
            loop_time <- append(loop_time,min(summary(benchmark)$mean))
          }
          
          if (length(all_weight) == 0) {
            all_weight <- min(instance_weight)
            all_time <- min(summary(benchmark)$mean)
          }
          else {
            all_weight <- append(all_weight,min(instance_weight))
            all_time <- append(all_time,min(summary(benchmark)$mean))
          }
        }
      }
  }
  # Recap for all the instances at the same size
  plot_weight_recap <- data.frame(structures = Structures_types,weight_log10 = log10(loop_weight))
  
  graph_weight_recap <- ggplot(data = plot_weight_recap,aes(x = structures, y=weight_log10)) +
    geom_bar(stat = "identity")
  print(graph_weight_recap + ggtitle(sprintf("%s %d %s","Weight recap for ",i,
                                             " elements structures")))
  
  plot_time_recap <- data.frame(structures = Structures_types,times_log10 = log10(loop_time))
  
  graph_time_recap <- ggplot(data = plot_time_recap,aes(x = structures, y=times_log10)) +
    geom_bar(stat = "identity")
  print(graph_time_recap + ggtitle(sprintf("%s %d %s","time recap for ",i,
                                           " elements Structures")))
}

# GLOBAL Recap

structures <- rep(Structures_types,3)
times_log10 <- log10(all_time)
weight_log10 <- log10(all_weight)
size <- c(rep(num_elem[1],5),rep(num_elem[2],5),rep(num_elem[3],5))
size <- as.character(size)

global_plot_weight_recap <- data.frame(structures,weight_log10,size)

global_graph_weight_recap <- ggplot(data = global_plot_weight_recap,aes(x = size, y=weight_log10,
                                                                        fill = structures)) + 
  geom_bar(position = "dodge", stat = "identity")
global_graph_weight_recap + ggtitle(sprintf("%s","weight recap graph"))

global_plot_time_recap <- data.frame(structures,times_log10,size)

global_graph_time_recap <- ggplot(data = global_plot_time_recap,aes(x = size, y=times_log10,
                                                                    fill = structures)) +
  geom_bar(position = "dodge",stat = "identity")
global_graph_time_recap + ggtitle(sprintf("%s"," time recap graph"))
```