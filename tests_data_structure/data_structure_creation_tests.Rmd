---
title: "data_structure"
output: html_document
---

```{r setup, include=FALSE}
options(tinytex.verbose = TRUE)
knitr::opts_chunk$set(echo = TRUE)
```

# Description

In this document, are the tests concerning the creation of different data structure and their filling.
We have 5 types, a list composed of objects, a class which has a list composed of objects, a data frame
based on an object and composed of an objects' list, a tibble based on a data frame and composed of
an objects' list and a data table also based on a data frame and composed of an objects' list.

The tests consist in filling these structures, in the purpose that they will contain 10K, 100K or 1M
objects.

Each object is composed of a name (character), a beginning and end date (numeric), a xml document (character),
a ground_name (character),a fstation (character),a fclim1 (character),a fclim2 (character),
a culturean (numeric), a number of plant (numeric), a simulation code (numeric), a data's list for the
first dominant plant (character) and the same goes for the second dominant plant, an observation file (character)
and the last is an element list that can be modify as we want.

The dominant plants lists are composed of a fplt (character), a ftec (character) and a flai (character)

There are 3 types of test. The first is a non pre-allocated list, the second is a pre-allocated 
vector and the last one is a pre-allocated list using the lapply method.

# Constructors

````{r constructors}
## functions file
source("data_structure_functions.R")

########################### LIBRARIES & GLOBAL VARIABLES/FUNCTIONs ################################
library(microbenchmark)
library(ggplot2)
library(tibble)
library(data.table)
library(dplyr)

# microbenchmark execution number
time = 100                                                                

## number of element
num_elem = 10000
```

# Tests

Before beginning the tests, let's declare some variables that will be used in graphs.

```{r variables}
# used for graph
structs <- c("list","Class","DataFrame","Tibble","DataTable")
Instances_modes <- c("PA Vector","lapply")

all_weight <- list() # all the differents wiehgts from instances
all_time <- list() # used to store all the instances generation time

```

```{r tests}

cpt <- 0
while (cpt < 3) {
  
  ######## LIST ########## 

  test <- vector_usm_list(num_elem)
  instance_weight <- object.size(test)
  
  test <- lapply_usm_list(num_elem)
  instance_weight <- append(instance_weight,object.size(test))
  
  plot_weight <- data.frame(Instanciation_modes = Instances_modes,weights = instance_weight)
  
  graph <- ggplot(data = plot_weight,aes(x =Instanciation_modes, y=weights)) + 
    geom_bar(stat = "identity")
  graph + ggtitle(sprintf("%d %s",num_elem," elements List"))
  
   
  loop_weight <- min(instance_weight)
  all_weight <- append(all_weight,min(instance_weight))
  
  benchmark <- microbenchmark(vector_usm_list(num_elem),lapply_usm_list(num_elem),times = time)
  
  loop_time <- min(summary(benchmark)$mean)
  all_time <- append(all_time,min(summary(benchmark)$mean))
  
  plot_time <- data.frame(Instanciation_modes = Instances_modes,
                        times = log10(summary(benchmark)$mean))
  
  graph <- ggplot(data = plot_time,aes(x = Instanciation_modes, y=times)) + 
    geom_bar(stat = "identity")
  graph + ggtitle(sprintf("%d %s",num_elem," elements List"))
  
  ggplot2::autoplot(benchmark) + ggtitle(sprintf("%s %d %s","Duration tests for a ",
                                                 num_elem," elements List"))
  
  ############# CLASS ###############
  
  test <- vector_usm_class(num_elem)
  instance_weight <- object.size(test)
  
  test <- lapply_usm_class(num_elem)
  instance_weight <- append(instance_weight,object.size(test))
  
  plot_weight <- data.frame(Instanciation_modes = Instances_modes,weight = instance_weight)
  
  graph <- ggplot(data = plot_weight,aes(x = Instanciation_modes, y=weight)) + 
    geom_bar(stat = "identity")
  graph + ggtitle(sprintf("%d %s",num_elem," elements Class"))
  
  loop_weight <- append(loop_weight,min(instance_weight))
  all_weight <- append(all_weight,min(instance_weight))
  
  benchmark <- microbenchmark(vector_usm_class(num_elem),lapply_usm_class(num_elem),times = time)
  
  loop_time <- append(loop_time,min(summary(benchmark)$mean))
  all_time <- append(all_time,min(summary(benchmark)$mean))
  
  plot_time <- data.frame(Instanciation_modes = Instances_modes,
                        times = summary(benchmark)$mean)
  
  graph <- ggplot(data = plot_time,aes(x = Instanciation_modes, y=times)) + 
    geom_bar(stat = "identity")
  graph + ggtitle(sprintf("%d %s",num_elem," elements Class"))
  
  ggplot2::autoplot(benchmark)  + 
    ggtitle(sprintf("%s %d %s","Duration tests for a ",num_elem," elements Class"))
 
  
  ######### DATA FRAME ##########
  
  test <- vector_usm_dataframe(num_elem)
  instance_weight <- object.size(test)
  
  test <- lapply_usm_dataframe(num_elem)
  instance_weight <- append(instance_weight,object.size(test))
  
  plot_weight <- data.frame(Instanciation_modes = Instances_modes, weight = instance_weight)
  
  graph <- ggplot(data = plot_weight,aes(x = Instanciation_modes, y=weight)) + 
    geom_bar(stat = "identity")
  graph + ggtitle(sprintf("%d %s",num_elem," elements DataFrame"))
  
  loop_weight <- append(loop_weight,min(instance_weight))
  all_weight <- append(all_weight,min(instance_weight))
  
  benchmark <- microbenchmark(vector_usm_dataframe(num_elem),lapply_usm_dataframe(num_elem),
                             times = time)
  
  loop_time <- append(loop_time,min(summary(benchmark)$mean))
  all_time <- append(all_time,min(summary(benchmark)$mean))
  
  plot_time <- data.frame(Instanciation_modes = Instances_modes,
                        times = summary(benchmark)$mean)
  
  graph <- ggplot(data = plot_time,aes(x = Instanciation_modes, y=times)) + 
    geom_bar(stat = "identity")
  graph + ggtitle(sprintf("%d %s",num_elem," elements DataFrame"))
  
  ggplot2::autoplot(benchmark)  + ggtitle(sprintf("%s %d %s","Duration tests for a ",
                                                  num_elem," elements DataFrame"))
  
  ######### TIBBLE ##############

  test <- vector_usm_tibble_from_usm_dataframe(num_elem)
  instance_weight <- object.size(test)
  
  test <- lapply_usm_tibble_from_usm_dataframe(num_elem)
  instance_weight <- append(instance_weight,object.size(test))
  
  plot_weight <- data.frame(Instanciattion_modes = Instances_modes,weight = instance_weight)
  
  graph <- ggplot(data = plot_weight,aes(x = Instanciation_modes, y=weight)) + 
    geom_bar(stat = "identity")
  graph + ggtitle(sprintf("%d %s",num_elem," elements Tibble"))
  
  loop_weight <- append(loop_weight,min(instance_weight))
  all_weight <- append(all_weight,min(instance_weight))
  
  benchmark = microbenchmark(vector_usm_tibble_from_usm_dataframe(num_elem),
                             lapply_usm_tibble_from_usm_dataframe(num_elem),times = time)
  
  loop_time <- append(loop_time,min(summary(benchmark)$mean))
  all_time = append(all_time,min(summary(benchmark)$mean))
  
  plot_time <- data.frame(Intanciation_modes = Instances_modes,
                        times = summary(benchmark)$mean)
  
  graph <- ggplot(data = plot_time,aes(x = Instanciation_modes, y=times)) + 
    geom_bar(stat = "identity")
  graph + ggtitle(sprintf("%d %s",num_elem," elements Tibble"))
  
  ggplot2::autoplot(benchmark)  + ggtitle(sprintf("%s %d %s","Duration tests for a ",
                                                  num_elem," elements Tibble"))
  
     
  ################ DATA TABLE #########################

  test <- vector_usm_datatable_from_usm_dataframe(num_elem)
  instance_weight <- object.size(test)
  
  test <- lapply_usm_datatable_from_usm_dataframe(num_elem)
  instance_weight <- append(instance_weight,object.size(test))
  
  plot_weight <- data.frame(Intanciation_modes = Instances_modes,
                        weight = instance_weight)
  
  graph <- ggplot(data = plot_weight,aes(x = Instanciation_modes, y=weight)) + 
    geom_bar(stat = "identity")
  graph + ggtitle(sprintf("%d %s",num_elem," elements DataTable"))
  
  loop_weight <- appedn(loop_weight,min(instance_weight))
  all_weight <- append(all_weight,min(instance_weight))
  
  benchmark = microbenchmark(vector_usm_datatable_from_usm_dataframe(num_elem),
                             lapply_usm_datatable_from_usm_dataframe(num_elem),times = time)
  
  loop_time - append(loop_time,min(summary(benchmark)$mean))
  all_time = append(all_time,min(summary(benchmark)$mean))
  
  plot_time <- data.frame(Instanciation_modes = Instances_modes,
                        times = summary(benchmark)$mean)
  graph <- ggplot(data = plot_time,aes(x = Instanciation_modes, y=times)) + 
    geom_bar(stat = "identity")
  graph + ggtitle(sprintf("%d %s",num_elem," elements DataTable"))
  
  ggplot2::autoplot(benchmark)  + ggtitle(sprintf("%s %d %s","Duration tests for a ",
                                                  num_elem," elements DataTable"))
  
  # LOOP RECAP
  
  plot_weight_recap <- data.frame(structures = structs,
                                  weight_log10 = log10(loop_weight))
  
  graph_weight_recap <- ggplot(data = plot_weight_recap,aes(x = structures, y=weight_log10)) + 
    geom_bar(stat = "identity")
  graph_weight_recap + ggtitle(sprintf("%s %d %s","Weight recap for ",
                                       num_elem," elements structures"))
  
  
  plot_time_recap <- data.frame(structures = structs,
                        times_log10 = log10(loop_time))
  
  graph_time_recap <- ggplot(data = plot_df,aes(x = structures, y=times_log10)) + 
    geom_bar(stat = "identity")
  graph_time_recap + ggtitle(sprintf("%s %d %s","time recap for ",
                                     num_elem," elements Structures"))

  
  num_elem <- num_elem * 10
  cpt <- cpt + 1
}
```


``` {r final recap}
plot_weight_recap <- data.frame(structures = rep(structs,3),
                                weight_log10 = log10(all_weight))

graph_weight_recap <- ggplot(data = plot_weight_recap,aes(x = structures, y=weight_log10)) + 
  geom_bar(stat = "identity")
graph_weight_recap + ggtitle(sprintf("%s","weight recap graph"))


plot_time_recap <- data.frame(structures = rep(structs,3),
                      times_log10 = log10(all_time))

graph_time_recap <- ggplot(data = plot_df,aes(x = structures, y=times_log10)) +
  geom_bar(stat = "identity")
graph_time_recap + ggtitle(sprintf("%s"," time recap graph"))

```
